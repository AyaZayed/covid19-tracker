import './css/App.css'
import { useState, useEffect } from 'react'
import CountryPicker from './components/CountryPicker'
import StatsCards from './components/StatsCards'
import Chart from './components/Chart'

export default function App() {
  const url = 'https://api.apify.com/v2/key-value-stores/tVaYRsPHLjNdNBu7S/records/LATEST?disableRedirect=true'

  const [covidData, setCovidData] = useState(null)
  const [countries, setCountries] = useState([])
  const [selectedCountry, setSelectedCountry] = useState('Algeria')
  const [infected, setInfected] = useState(0)
  const [recovered, setRecovered] = useState(0)
  const [deceased, setDeceased] = useState(0)
  const [date, setDate] = useState(null)

  useEffect(() => {
    fetch(url)
      .then(res => res.json())
      .then(data => {
        setCovidData(data)
        setCountries(data.map(country => country.country))
      })
      .catch(err => console.log(err))
  }, [])

  useEffect(() => {
    if (covidData) {
      const country = covidData.find(country => country.country === selectedCountry)
      setInfected(country.infected)
      setRecovered(country.recovered)
      setDeceased(country.deceased)
      setDate(new Date(country.lastUpdatedApify).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })
      )
    }
  }, [selectedCountry, covidData])

  const headerImg = new URL('../public/header.svg', import.meta.url)

  console.log(date)

  return (
    <>
      <header>
        <img src={headerImg} alt="covid 19" />
      </header>
      <StatsCards infected={infected} recovered={recovered} deceased={deceased} date={date} />
      <CountryPicker countries={countries} setSelectedCountry={setSelectedCountry} />
      <Chart infected={infected} recovered={recovered} deceased={deceased} selectedCountry={selectedCountry} />
    </>
  )
}
